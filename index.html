<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Chat</title>
  <style>
    :root {
      --success-color: #90e46c;
      --line-color: #aeacff;
      --primary-color: #5f5cd9;
      --hover-color: #4847a8;
      --border-radius: 8px;
      --spacing: 1em;
      --light-bg-color: #b1aff1;
      --id-color: #4a4a4d;
    }
    body {
      margin: 0;
      padding: 0;
    }
    .outer {
      padding: var(--spacing);
    }
    .connect-wrap {
      padding: var(--spacing);
      background: var(--success-color);
      color: var(--id-color);
    }
    .btn {
      display: flex;
      justify-content: center;
      align-items: center;
      padding-inline: 8px;
      width: 120px;
      font-size: 14px;
      margin-block: var(--spacing);
    }


    #systemMessage {
      background: pink;
      border-radius: var(--border-radius);
      padding: .25rem .75rem;
    }

    h3 {
      font-size: 18px;
      margin: 0;
    }
    p {
      margin: 0;
      color: #766b7d;
      font-size: 14px;
    }
    
    ul, li {
      list-style: none;
      list-style-type: disclosure-closed;
      margin: 0;
      padding: 0
    }
    
    ul {
      padding-block: 0;
      padding-inline-start: var(--spacing);
    }
    
    li {
      line-height: 2em;
    }
    
    button {
      width: 100%;
      padding: 0.5em;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: var(--hover-color);
    }

    input {
      padding: 0.5em;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      font-size: 1em;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing);
    }
    .sys {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: var(--spacing);
    }
    #myId {
      font-weight: normal;
    }
    .id {
      color: var(--id-color);
    }

    .inner-wrap {
      background: #d1d0f8;
      padding: var(--spacing);
      border-radius: var(--border-radius);
    }

    .list {
      max-width: 960px;
      display: flex;
      justify-content: center;
      gap: var(--spacing);
      flex-direction: column;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      padding: var(--spacing) .75em;
      margin-bottom: var(--spacing);
    }
    #onlineNinjasList {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: var(--spacing);
      div {
        display: inline-block;
        padding: .25em .75em;
        border: 1px solid var(--line-color);
        border-radius: var(--border-radius);;
      }
    }
    #clientIdList {
      display: flex;
      flex-wrap: wrap;
      gap: .5em;
      div {
        display: inline-block;
        padding: .25em .5em;
        border-radius: var(--border-radius);
        border: 1px solid var(--line-color);
      }
    }
    
    .wrap {
      display: flex;
      justify-content: center;
      gap: var(--spacing);
      flex-direction: column;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      padding: var(--spacing) .75em;
      margin-bottom: var(--spacing);

      .inner-wrap &:last-child {
        margin-bottom: 0;
      }
    }
    .flex-row-wrap {
      display: flex;
      gap: .5em;
      width: 100%;
    }
    .flex-column-wrap {
      display: flex;
      flex-direction: column;
      gap: .5em;
      width: 100%;
    }
    .flex-1 {
      flex: 1
    }
    .hide {
      display: none;
    }
    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin: 4px 0;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      background: var(--light-bg-color);
    }
    .user-item_inner {
      display: flex;
      flex-direction: column;
    }

    .user-item button {
      width: auto;
      padding: 4px 8px;
      font-size: 14px;
    }

    .user-item span {
      margin-right: 8px;
      color: var(--id-color);
    }
    .mb-10 {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="connect-wrap">é€£ç·šç‹€æ…‹ï¼š
    <span class="connect-status"></span>
  </div>

  <div class="outer">
    <div class="sys"><span>ğŸ“¢</span> : <span id="systemMessage"></span></div>
    <div class="sys">
      æˆ‘çš„:
      <div id="myId">
        <div class="id custom-id"></div>
        <div class="id connect-id"></div>
        <button class="btn" onclick="reconnect()">ğŸ¤ğŸ» é‡æ–°é€£ç·š</button>
        <button class="btn" onclick="simulateDisconnect()">æ¨¡æ“¬ä¼ºæœå™¨æ–·ç·š</button>
      </div>
    </div>

    <div class="container">
      <div class="inner-wrap">
        <div class="wrap">
          <div class="flex-column-wrap">
            <input class="messageInput" type="text" placeholder="çµ¦å…¨å“¡çš„è¨Šæ¯è¼¸å…¥æ¡†" />
            <button onclick="sendMessage()">çµ¦å…¨éƒ¨æˆå“¡</button>
          </div>
        </div>

        <div class="wrap">
          <div class="flex-column-wrap">
            <input class="messageInput targetMessageInput" type="text" placeholder="çµ¦å€‹äººçš„è¨Šæ¯è¼¸å…¥æ¡†" />
            <div class="flex-row-wrap">
              <input id="targetUserId" class="flex-1" type="text" placeholder="ç›®æ¨™ä½¿ç”¨è€… ID" />
              <button class="flex-1" onclick="sendPrivateMessage()">å‚³è¨Šçµ¦æŒ‡å®šä½¿ç”¨è€…</button>
            </div>
          </div>
        </div>
      </div>

      <div class="inner-wrap">
        <div class="list">
          <h3>FROM: MESSAGE</h3>
          <ul id="messageList"></ul>
        </div>
      </div>

      <div class="inner-wrap">
        <h3 class="mb-10">åœ¨ç·šä½¿ç”¨è€…åˆ—è¡¨</h3>
        <div id="onlineUsersList" class="list"></div>
      </div>

      <div class="inner-wrap">
        <div class="wrap">
          <button onclick="getMyData()">çµ¦æˆ‘è³‡æ–™ï¼Œåªæœ‰æˆ‘æœƒçœ‹åˆ° ğŸ¤­</button>
          <p>å‘å¾Œç«¯è«‹æ±‚è³‡æ–™ï¼Œåªæœƒå›å‚³çµ¦è«‹æ±‚çš„ä½¿ç”¨è€…ï¼Œå…¶ä»–äººä¸æœƒæ”¶åˆ°</p>
          <div id="myData"></div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    // å»ºç«‹ WebSocket é€£ç·š
    const socket = io('http://localhost:81', {
      transports: ['websocket'],
      reconnection: true, // å•Ÿç”¨è‡ªå‹•é‡é€£ï¼ˆé è¨­ trueï¼‰
      autoConnect: true,  // æ·»åŠ é€™è¡Œ
      reconnectionAttempts: 6, // æœ€å¤šé‡é€£æ¬¡æ•¸ (consle æœƒé¡¯ç¤ºï¼šwebsocket.js:119 WebSocket connection to 'ws://localhost:81/socket.io/?EIO=4&transport=websocket' failed:)
      reconnectionDelay: 1000, // åˆå§‹å»¶é²ç§’æ•¸
      reconnectionDelayMax: 5000, // æœ€å¤§å»¶é²å¹¾ç§’
      randomizationFactor: 0.5, // Socket.IO å®¢æˆ¶ç«¯ç”¨æ–¼æ§åˆ¶è‡ªå‹•é‡é€£å»¶é²çš„åƒæ•¸ï¼Œç”¨ä¾†åœ¨é‡é€£é–“éš”ä¸­å¼•å…¥éš¨æ©Ÿæ€§ï¼Œé¿å…æ‰€æœ‰å®¢æˆ¶ç«¯åŒæ™‚é‡é€£å°è‡´ä¼ºæœå™¨éè¼‰ã€‚ä»‹æ–¼ 0 åˆ° 1 çš„æ•¸å­—ï¼ˆé è¨­ 0.5ï¼‰
    });

    // æ•ç²å…¨å±€éŒ¯èª¤
    window.onerror = function (message, source, lineno, colno, error) {
      console.error('Global error:', { message, source, lineno, colno, error });
      return true; // é˜²æ­¢ç€è¦½å™¨é»˜èªè™•ç†
    };
    window.onunhandledrejection = function (event) {
      console.error('Unhandled promise rejection:', event.reason);
    };
    // æª¢æŸ¥é é¢æ˜¯å¦å³å°‡é‡è¼‰
    window.onbeforeunload = function (event) {
      console.log('------------- é é¢å³å°‡é‡è¼‰ -------------');
      console.log('Socket connected:', socket.connected);
      console.log('Socket disconnected:', socket.disconnected);
    };

    function logInfo(event, message, details = {}) {
      const errorLog = {
        timestamp: new Date().toISOString(),
        event,
        message,
        customId: localStorage.getItem('customId'),
        ...details,
      };
      console.info('ğŸ„ LOGINFO:', errorLog);
    }

    // å„²å­˜ä½¿ç”¨è€…è­˜åˆ¥ç¢¼
    let customId = localStorage.getItem('customId');
    if (!customId) {
      customId = `custom_${Date.now()}_${Math.random().toString(6).substr(2, 5)}`;
      localStorage.setItem('customId', customId);
    }

    const connectStatusWrap = document.querySelector('.connect-wrap')
    const connectStatus = document.querySelector('.connect-status')
    const sysMessageElement = document.getElementById('systemMessage')
    const messageList = document.getElementById('messageList')


    // é€£ç·šæˆåŠŸå¾Œï¼Œç™¼é€ä½¿ç”¨è€…é€£ç·šäº‹ä»¶
    socket.on('connect', () => {
      console.log('\x1b[31m%s\x1b[0m', '--- âœ… é€£ç·šæˆåŠŸå¾Œï¼Œç™¼é€ä½¿ç”¨è€…é€£ç·šäº‹ä»¶ ---')
      connectStatus.textContent = 'âœ… é€£ç·šæˆåŠŸ'
      // ç™¼é€ä½¿ç”¨è€…é€£ç·šäº‹ä»¶ï¼ŒåŒ…å«ä½¿ç”¨è€…è­˜åˆ¥ç¢¼
      socket.emit('userConnect', { 
        customId: customId,
        clientId: socket.id
      });

      // æ¸…ç©ºç³»çµ±è¨Šæ¯
      sysMessageElement.textContent = '';
    });

    // é€£ç·šæ–·ç·š
    socket.on('disconnect', (reason) => {
      logInfo('disconnect', `â›” æ–·ç·šåŸå› : ${reason}`);
      if (reason === 'io server disconnect') {
        // æœå‹™å™¨å¼·åˆ¶æ–·ç·šï¼Œä¸è‡ªå‹•é‡é€£
        connectStatus.textContent = `â›” é€£ç·šæ•¸è¶…éé™åˆ¶ï¼Œè«‹é—œé–‰å…¶ä»–åˆ†é `;
        console.log('\x1b[31m%s\x1b[0m', '--- â›”â›”â›” æœå‹™å™¨æ–·é–‹é€£æ¥ï¼Œä¸é‡é€£ â›”â›”â›” ---');
      } else if (reason === 'io client disconnect') {
        // å®¢æˆ¶ç«¯ä¸»å‹•æ–·ç·šï¼Œä¸è‡ªå‹•é‡é€£
        connectStatus.textContent = `â›” å®¢æˆ¶ç«¯æ–·é–‹é€£æ¥ï¼Œä¸é‡é€£`;
        console.log('\x1b[31m%s\x1b[0m', '--- âš ï¸âš ï¸âš ï¸ å®¢æˆ¶ç«¯æ–·é–‹é€£æ¥ï¼Œä¸é‡é€£ âš ï¸âš ï¸âš ï¸ ---');
      } else {
        // å…¶ä»–åŸå› ï¼ˆå¦‚ç¶²çµ¡å•é¡Œï¼‰ï¼Œsocket.io-client é è¨­æœƒè‡ªå‹•é‡é€£
        // å¦‚æœæƒ³é˜»æ­¢é€™ç¨®æƒ…æ³ä¸‹çš„é‡é€£ï¼š
        connectStatus.textContent = `â›” æ–·ç·šäº†ï¼Œæ–·ç·šåŸå› : ${reason}`;
        // socket.disconnect(); // å…ˆè¨»è§£ï¼Œè®“ Socket.IO è‡ªå‹•é‡é€£
      }
    });

    
    // TODO(ç›®å‰æ¸¬ä¸å‡ºä¾†): é‡è©¦é€£ç·š
    socket.on('reconnect', (attempt) => {
      logInfo('reconnect', `ç¬¬ ${attempt} æ¬¡é‡é€£æˆåŠŸ`);
      connectStatus.textContent = 'âœ… é‡é€£æˆåŠŸ';
    });

    // é€£ç·šéŒ¯èª¤
    socket.on('connect_error', (error) => {
      logInfo('connect_error', `â›” é€£ç·šéŒ¯èª¤: ${error.message}`, { error });
      connectStatus.textContent = `â›” é€£ç·šéŒ¯èª¤: ${error.message}`;
    });



    // é‡é€£é‚è¼¯
    let lastReconnectTime = 0;
    const reconnectInterval = 60000; // 1 åˆ†é˜
    const maxReconnectsPerMinute = 3;
    let reconnectCount = 0;
    
    // TODO(ç›®å‰æ¸¬ä¸å‡ºä¾†): é‡é€£é‚è¼¯
    socket.on('reconnect_attempt', (attempt) => {
      logInfo('reconnect_attempt', `ğŸ°ğŸ°ğŸ°æ­£åœ¨é€²è¡Œç¬¬ ${attempt} æ¬¡é‡é€£`);
      const now = Date.now();
      if (now - lastReconnectTime > reconnectInterval) {
        reconnectCount = 0; // é‡ç½®è¨ˆæ•¸
        lastReconnectTime = now;
      }
      if (reconnectCount >= maxReconnectsPerMinute) {
        // åœæ­¢é‡é€£ (å¸ƒæ—å€¼ï¼Œæ§åˆ¶æ˜¯å¦å•Ÿç”¨è‡ªå‹•é‡é€£ï¼Œé è¨­ trueï¼Œè¡¨ç¤ºæ–·ç·šå¾Œæœƒè‡ªå‹•é‡é€£ï¼Œfalse æœƒç¦ç”¨è‡ªå‹•é‡é€£ï¼Œä¹‹å¾Œçš„æ–·ç·šä¸æœƒè§¸ç™¼ reconnect_attempt)
        // ä¿®æ”¹ opts.reconnection åªå½±éŸ¿ç•¶å‰é€£ç·šå¯¦ä¾‹ï¼Œä¸æœƒæ”¹è®Šå…¶ä»–åˆ†é ã€‚
        logInfo('âš ï¸ reconnect_attempt', 'ä¸€åˆ†é˜å…§é‡é€£æ¬¡æ•¸éå¤šï¼Œæš«åœé‡é€£');
        // socket.io.opts.reconnection = false;
        sysMessageElement.textContent = 'é‡é€£æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
        return;
      }
      reconnectCount++;
    });

    // TODO(ç›®å‰æ¸¬ä¸å‡ºä¾†): é‡æ–°é€£ç·šå¤±æ•—
    socket.on('reconnect_failed', () => {
      logInfo('âš ï¸ reconnect_attempt', 'é‡é€£å¤±æ•—ï¼Œå·²é”ä¸Šé™ï¼Œè«‹æ‰‹å‹•é‡æ–°æ•´ç†');
      sysMessageElement.textContent = 'ç„¡æ³•é€£ç·šï¼Œè«‹é‡æ–°æ•´ç†é é¢';
    });

    // æ¥æ”¶é€£ç·šç¢ºèª
    socket.on('connectionConfirmed', (data) => {
      logInfo('connectionConfirmed', 'ğŸ†— ç¢ºèªé€£ç·š connectionConfirmed', { data })
      const myIdElement = document.getElementById('myId');
      const customId = document.querySelector('.custom-id')
      const connectId = document.querySelector('.connect-id')
      if (myIdElement) {
        customId.textContent = `è‡ªè¨‚çš„ ğŸ†” : ${data.customId}`;
        connectId.textContent = `é€£ç·šçš„ ğŸ†” : ${data.clientId}`;
      }
    });

    // æ¥æ”¶åœ¨ç·šä½¿ç”¨è€…åˆ—è¡¨
    socket.on('onlineUsers', (users) => {
      console.log('\x1b[44m%s\x1b[0m', '--- ONLINE USERS ---', users);
      const onlineUsersList = document.getElementById('onlineUsersList');
      if (onlineUsersList) {
        if (users.length === 0) {
          onlineUsersList.innerHTML = '<div>ç„¡åœ¨ç·šä½¿ç”¨è€…</div>';
        } else {
          onlineUsersList.innerHTML = users.map(user => 
            `<div class="user-item">
              <div class="user-item_inner">
                <span>${user.customId}</span>
                <span>(${user.connectionCount} å€‹é€£ç·š)</span>
              </div>
              <button onclick="selectUser('${user.customId}')">é¸æ“‡</button>
            </div>`
          ).join('');
        }
      }
    });

    // æ›´æ–°è¨Šæ¯åˆ—è¡¨
    socket.on('message', (msg) => {
      const li = document.createElement('li');
      li.textContent = `${msg}`;
      messageList.appendChild(li);
    });

    // æ¥æ”¶ç§è¨Š
    socket.on('privateMessage', (data) => {
      console.log('æ¥æ”¶ç§è¨Š:', data);
      logInfo('privateMessage', 'ğŸ’¬ æ¥æ”¶ç§è¨Š', data)
      const li = document.createElement('li');
      li.textContent = `${data.from} ç§è¨Šä½ : ${data.message} (${new Date(data.timestamp).toLocaleTimeString()})`;
      li.style.color = 'blue';
      messageList.appendChild(li);
    });

    // éŒ¯èª¤è¨Šæ¯
    socket.on('errorMessage', (msg) => {
      console.log('éŒ¯èª¤è¨Šæ¯ âš ï¸:', msg); // æ·»åŠ æ—¥èªŒ
      const li = document.createElement('li');
      li.textContent = `éŒ¯èª¤ âš ï¸: ${msg}`;
      li.style.color = 'red';
      messageList.appendChild(li);
      // å¦‚æœæ˜¯é€£ç·šæ•¸è¶…éé™åˆ¶ï¼Œç¦ç”¨è‡ªå‹•é‡é€£
      if (msg === '8ï¸âƒ£8ï¸âƒ£6ï¸âƒ£ é€£ç·šæ•¸è¶…éé™åˆ¶') {
        console.log('é€£ç·šæ•¸è¶…éé™åˆ¶ï¼Œç¦ç”¨è‡ªå‹•é‡é€£'); // æ·»åŠ æ—¥èªŒ
        // socket.io.opts.reconnection = false; // ç¦ç”¨è‡ªå‹•é‡é€£
        // socket.disconnect(); // ä¸»å‹•æ–·é–‹é€£ç·š
        socket.close(); // å®Œå…¨é—œé–‰ Socket.IO é€£ç·š
        sysMessageElement.textContent = 'é€£ç·šæ•¸è¶…éé™åˆ¶ï¼Œè«‹é—œé–‰å…¶ä»–åˆ†é å¾Œæ‰‹å‹•é‡æ–°é€£ç·š';
      }
    });

    // ç³»çµ±è¨Šæ¯
    socket.on('sysMessage', (msg) => {
      logInfo('systemMessage', `ğŸ“¢ ç³»çµ±è¨Šæ¯: ${msg}`);
      const systemMessage = document.getElementById('systemMessage');
      if (systemMessage) {
        systemMessage.textContent = `${msg}`;
      }
    });


    socket.on('myData', (data) => {
      console.log('\x1b[33m%s\x1b[0m', '=== åªå‚³çµ¦æˆ‘è‡ªå·±æœƒé¡¯ç¤ºçš„è³‡æ–™ ===', data);
      const myDataWrap = document.querySelector('#myData');
      // æ¸…ç©ºç¾æœ‰å…§å®¹
      myDataWrap.innerHTML = '';
      data.forEach((item) => {
        const singleItem = document.createElement('div');
        singleItem.textContent = `${item.id}. ${item.title}`;
        singleItem.style.padding = '8px';
        singleItem.style.margin = '4px 0';
        singleItem.style.borderBottom = '1px solid #8481d9';
        myDataWrap.appendChild(singleItem);
      });
    });


    //ğŸ‘†ğŸ»æ‰‹å‹•è§¸ç™¼é‡æ–°é€£ç·š
    function reconnect() {
      console.log('\x1b[33m%s\x1b[0m', '============ ğŸ‘‡ğŸ» æ‰‹å‹•è§¸ç™¼é‡æ–°é€£ç·š ğŸ‘‡ğŸ» ============')
      socket.io.opts.reconnection = true; // å•Ÿç”¨è‡ªå‹•é‡é€£
      socket.connect();
      messageList.innerHTML = ''; // æ¸…ç©ºè¨Šæ¯åˆ—è¡¨
    }


    // ç™¼é€è¨Šæ¯çµ¦æ‰€æœ‰äºº
    function sendMessage() {
      const message = document.querySelector('.messageInput').value;
      socket.emit('sendMessage', message);
      document.querySelector('.messageInput').value = '';
    }

    // ç™¼é€ç§è¨Š
    function sendPrivateMessage() {
      const targetUserId = document.getElementById('targetUserId').value;
      const message = document.querySelector('.targetMessageInput').value;
      
      if (targetUserId && message) {
        socket.emit('sendPrivateMessage', {
          targetUserId: targetUserId,
          message: message,
          fromUserId: customId
        });
        document.querySelector('.targetMessageInput').value = '';
        document.querySelector('#targetUserId').value = '';
      }
    }

    // é¸æ“‡ä½¿ç”¨è€…
    function selectUser(targetUserId) {
      document.getElementById('targetUserId').value = targetUserId;
    }

    // å‘å¾Œç«¯è«‹æ±‚è³‡æ–™ï¼Œåªæœƒå›å‚³çµ¦è«‹æ±‚çš„ä½¿ç”¨è€…
    function getMyData() {
      socket.emit('getMyData', { clientId: customId });
    }

    // æ¨¡æ“¬å¾Œç«¯æ–·é–‹æ‰€æœ‰é€£ç·šï¼Œæ¸¬è©¦é‡é€£è¡Œç‚º
    function simulateDisconnect() {
      console.log('Sending simulateDisconnect event to server');
      socket.emit('simulateDisconnect');
    }

  </script>
</body>
</html>