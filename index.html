<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Chat</title>
  <style>
    :root {
      --line-color: #aeacff;
      --primary-color: #5f5cd9;
      --hover-color: #4847a8;
      --border-radius: 8px;
      --spacing: 1em;
    }

    #systemMessage {
      background: pink;
      border-radius: var(--border-radius);
      padding: .25rem .75rem;
    }

    h3 {
      font-size: 18px;
      margin: 0;
    }
    p {
      margin: 0;
      color: #766b7d;
      font-size: 14px;
    }
    
    ul, li {
      list-style: none;
      list-style-type: disclosure-closed;
      margin: 0;
      padding: 0
    }
    
    ul {
      padding-block: 0;
      padding-inline-start: var(--spacing);
    }
    
    li {
      line-height: 2em;
    }
    
    button {
      width: 100%;
      padding: 0.5em;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: var(--hover-color);
    }

    input {
      padding: 0.5em;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      font-size: 1em;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing);
    }
    .sys {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: var(--spacing);
    }

    .inner-wrap {
      background: #d1d0f8;
      padding: var(--spacing);
      border-radius: var(--border-radius);;
    }

    .list {
      max-width: 960px;
      display: flex;
      justify-content: center;
      gap: var(--spacing);
      flex-direction: column;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      padding: var(--spacing) .75em;
      margin-bottom: var(--spacing);
    }
    #onlineNinjasList {
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: var(--spacing);
      div {
        display: inline-block;
        padding: .25em .75em;
        border: 1px solid var(--line-color);
        border-radius: var(--border-radius);;
      }
    }
    #clientIdList {
      display: flex;
      flex-wrap: wrap;
      gap: .5em;
      div {
        display: inline-block;
        padding: .25em .5em;
        border-radius: var(--border-radius);
        border: 1px solid var(--line-color);
      }
    }
    
    .wrap {
      display: flex;
      justify-content: center;
      gap: var(--spacing);
      flex-direction: column;
      border: 1px solid var(--line-color);
      border-radius: var(--border-radius);
      padding: var(--spacing) .75em;
      margin-bottom: var(--spacing);

      .inner-wrap &:last-child {
        margin-bottom: 0;
      }
    }
    .flex-row-wrap {
      display: flex;
      gap: .5em;
      width: 100%;
    }
    .flex-column-wrap {
      display: flex;
      flex-direction: column;
      gap: .5em;
      width: 100%;
    }
    .flex-1 {
      flex: 1
    }
    .hide {
      display: none;
    }
  </style>
</head>
<body>
  <div class="sys">ğŸ“¢ : <span id="systemMessage"></span></div>
  <div class="sys">æˆ‘çš„ ğŸ†”: <span id="myId"></span></div>

<div class="container">
  <div class="inner-wrap">
    <div class="wrap">
      <div class="flex-column-wrap">
        <input class="messageInput" type="text" placeholder="çµ¦å…¨å“¡çš„è¨Šæ¯è¼¸å…¥æ¡†" />
        <button onclick="sendMessage()">çµ¦å…¨éƒ¨æˆå“¡</button>
      </div>
    </div>

    <div class="wrap">
      <div class="flex-column-wrap">
        <input class="messageInput targetMessageInput" type="text" placeholder="çµ¦å€‹äººçš„è¨Šæ¯è¼¸å…¥æ¡†" />
        <div class="flex-row-wrap">
          <input id="targetId" class="flex-1" type="text" placeholder="ç›®æ¨™ ID" />
          <button class="flex-1" onclick="sendToSpecificId()">å‚³è¨Šçµ¦æŒ‡å®šID</button>
        </div>
      </div>
    </div>
  </div>


  <div class="inner-wrap">
    <div class="list">
      <h3>FROM: MESSAGE</h3>
      <ul id="messageList"></ul>
    </div>
  </div>


  <div class="inner-wrap">
    <h3>åœ¨ç·šå¿è€…åˆ—è¡¨</h3>
    <div id="onlineNinjasList" class="list"></div>
  </div>

  <div class="inner-wrap">
    <div class="wrap">
      <button onclick="getMyData()">çµ¦æˆ‘è³‡æ–™ï¼Œåªæœ‰æˆ‘æœƒçœ‹åˆ° ğŸ¤­</button>
      <p>å‘å¾Œç«¯è«‹æ±‚è³‡æ–™ï¼Œåªæœƒå›å‚³çµ¦è«‹æ±‚çš„ä½¿ç”¨è€…ï¼Œå…¶ä»–äººä¸æœƒæ”¶åˆ°</p>
      <div id="myData"></div>
    </div>
  </div>

</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
  <script>
    // é€£æ¥åˆ° WebSocket æœå‹™
    const socket = io('http://localhost:81', { transports: ['websocket'] });

    // å„²å­˜å®¢æˆ¶ç«¯ ID çš„è®Šæ•¸
    let clientId = '';


    // socket.on(eventName, callback) æ˜¯ç”¨ä¾†ç›£è½ç‰¹å®šäº‹ä»¶çš„æ–¹æ³•
    // å®¢æˆ¶ç«¯èˆ‡æœå‹™ç«¯çš„ WebSocket é€£ç·šå»ºç«‹å®Œæˆæ™‚ï¼Œsocket.io æœƒè‡ªå‹•è§¸ç™¼ 'connect' äº‹ä»¶ï¼Œç„¶å¾ŒåŸ·è¡Œå›å‘¼å‡½æ•¸ï¼ˆcallbackï¼‰ä¸­çš„ç¨‹å¼ç¢¼ã€‚
    // ç›£è½é€£ç·šæˆåŠŸäº‹ä»¶ï¼Œä¸¦å–å¾— socket.id
    socket.on('connect', () => {
      console.log('ğŸ‰‘--- é€£ç·šæˆåŠŸ ---ğŸ‰‘');
      clientId = socket.id; // å–å¾—å®¢æˆ¶ç«¯ ID
      document.getElementById('myId').textContent = clientId; // é¡¯ç¤ºå®¢æˆ¶ç«¯ ID
    });

    // æ›´æ–°åˆ—æ¯åˆ—è¡¨
    socket.on('message', (msg) => {
      const li = document.createElement('li');
      li.textContent = `${clientId} ğŸ’¬ï¼š ${msg}`;
      document.getElementById('messageList').appendChild(li);
    });

    // ç§è¨Š
    socket.on('privateMessage', (msg) => {
      const li = document.createElement('li');
      li.textContent = `${msg}`;
      document.getElementById('messageList').appendChild(li);
    });

    // éŒ¯èª¤è¨Šæ¯
    socket.on('errorMessage', (msg) => {
      const li = document.createElement('li');
      li.textContent = `éŒ¯èª¤ âš ï¸: ${msg}`;
      li.style.color = 'red';
      document.getElementById('messageList').appendChild(li);
    });

    // ç›£è½æœå‹™ç«¯(ninjas.service create)ç™¼ä¾†çš„ 'ninjaMessage' äº‹ä»¶
    socket.on('sysMessage', (msg) => {
      console.log('---- sysMessage ğŸ“¢ ----')
      const systemMessage = document.getElementById('systemMessage');
      systemMessage.textContent = `${msg}`;
    })





    // å–å¾—æ‰€æœ‰é€£ç·šçš„å®¢æˆ¶ç«¯ ID
    function getAllIds() {
      socket.emit('getAllClientIds');
    }
    // æ¥æ”¶å¾Œç«¯å‚³å›ä¾†çš„ id è³‡è¨Š
    socket.on('clientIds', (ids) => {
      console.log('æ”¶åˆ°æ‰€æœ‰å®¢æˆ¶ç«¯ ID:', ids);
      const clientIdList = document.getElementById('clientIdList');
      clientIdList.innerHTML = ''; // æ¸…ç©ºèˆŠè³‡æ–™
      clientIdList.classList.remove('hide'); // é¡¯ç¤ºä¸‹æ‹‰é¸å–®
      ids.forEach(id => {
        const eachId = document.createElement('div');
        eachId.textContent = id;
        clientIdList.appendChild(eachId);
      });
    });







    function sendMessage() {
      const message = document.querySelector('.messageInput').value;
      // socket.emit('xxxx', payload)ï¼Œxxxx æ˜¯ç›£è½ chat.gatewayä¸­ï¼Œ@SubscribeMessage('xxxx') ä¸­çš„äº‹ä»¶
      socket.emit('sendMessage', message);
      setTimeout(() => {
        resetMessageInput();
      }, 1000);
    }

    // æ–°å¢æ–¹æ³•ï¼šç™¼é€è¨Šæ¯çµ¦ç‰¹å®š ID çš„å®¢æˆ¶ç«¯
    function sendToSpecificId() {
      const message = document.querySelector('.targetMessageInput').value;
      const targetId = document.getElementById('targetId').value;
      socket.emit('sendToSpecificId', { targetId, message });
      setTimeout(() => {
        resetMessageInput();
      }, 1000);
    }

    // å‘å¾Œç«¯è«‹æ±‚è³‡æ–™ï¼Œåªæœƒå›å‚³çµ¦è«‹æ±‚çš„ä½¿ç”¨è€…
    function getMyData() {
      socket.emit('getMyData', { clientId });
    }
    socket.on('myData', (data) => {
      console.log('\x1b[33m%s\x1b[0m', '=== åªå‚³çµ¦æˆ‘è‡ªå·±æœƒé¡¯ç¤ºçš„è³‡æ–™ ===', data);
      const myDataWrap = document.querySelector('#myData');
      // æ¸…ç©ºç¾æœ‰å…§å®¹
      myDataWrap.innerHTML = '';
      data.forEach((item) => {
        const singleItem = document.createElement('div');
        singleItem.textContent = `${item.id}. ${item.title}`;
        singleItem.style.padding = '8px';
        singleItem.style.margin = '4px 0';
        singleItem.style.borderBottom = '1px solid #8481d9';
        myDataWrap.appendChild(singleItem);
      });
    });

    // æ¸…ç©ºè¼¸å…¥æ¡†çš„å…§å®¹
    function resetMessageInput() {
      document.querySelectorAll('.messageInput').forEach(input => input.value = '');
    }

    // ç›£è½å¿è€…å‰µå»ºäº‹ä»¶
    socket.on('ninjaCreated', (data) => {
      console.log('å¿è€…å‰µå»ºæˆåŠŸ:', data);
    });

    // ç›£è½åœ¨ç·šå¿è€…è³‡æ–™
    socket.on('onlineNinjas', (data) => {
      console.log('åœ¨ç·šå¿è€…è³‡æ–™:', data);
      const onlineNinjasList = document.querySelector('#onlineNinjasList');
      onlineNinjasList.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
      
      data.forEach((ninja) => {
        const ninjaItem = document.createElement('div');
        ninjaItem.textContent = `${ninja.id}`;
        onlineNinjasList.appendChild(ninjaItem);
      });
    });

  </script>
</body>
</html>